package build

import (
	"bytes"
	"text/template"
)

const (
	// CPU-only Dockerfile template
	cpuDockerfileTemplate = `# Generated by cozyctl
# Configuration: {{ .Description }}
FROM {{ .BaseImage }}

WORKDIR /app

# Copy application code
{{- if .Root }}
COPY ./{{ .Root }} .
{{- else }}
COPY . .
{{- end }}

# Install Python dependencies from pyproject.toml
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir .

# Set environment variables
{{- range $key, $value := .Environment }}
ENV {{ $key }}="{{ $value }}"
{{- end }}

# Default command - runs gen-worker entrypoint
{{- if .Entrypoint }}
CMD {{ .Entrypoint }}
{{- else }}
CMD ["python", "-m", "gen_worker.entrypoint"]
{{- end }}
`

	// GPU-enabled Dockerfile template (PyTorch + CUDA)
	gpuDockerfileTemplate = `# Generated by cozyctl
# Configuration: {{ .Description }}
# Note: This image is CUDA {{ .CudaVersion }} compatible and will run on CUDA {{ .CudaVersion }}+ hosts
FROM {{ .BaseImage }}

WORKDIR /app

# Copy application code
{{- if .Root }}
COPY ./{{ .Root }} .
{{- else }}
COPY . .
{{- end }}

# Install system dependencies (if needed)
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Upgrade pip and install dependencies
# PyTorch is already installed in the base image
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir .

# Set environment variables
ENV NVIDIA_VISIBLE_DEVICES=all
ENV NVIDIA_DRIVER_CAPABILITIES=compute,utility
{{- range $key, $value := .Environment }}
ENV {{ $key }}="{{ $value }}"
{{- end }}

# Default command - runs gen-worker entrypoint
{{- if .Entrypoint }}
CMD {{ .Entrypoint }}
{{- else }}
CMD ["python", "-m", "gen_worker.entrypoint"]
{{- end }}
`
)

// DockerfileData contains the data for Dockerfile template rendering
type DockerfileData struct {
	BaseImage    string
	Environment  map[string]string
	Entrypoint   string // Custom entrypoint command (optional)
	DeploymentID string
	Description  string
	IsGPU        bool
	CudaVersion  string
	Root         string
}

// GenerateDockerfile creates a Dockerfile from the template and cozy config
func GenerateDockerfile(baseImage string, cozyConfig *ToolsCozyConfig) (string, error) {
	isGPU := cozyConfig.Pytorch != "" || cozyConfig.Cuda != ""

	cudaVersion := normalizeCuda(cozyConfig.Cuda)
	if cudaVersion == "" && cozyConfig.Pytorch != "" {
		cudaVersion = "12.6" // default CUDA version when pytorch is specified
	}

	data := DockerfileData{
		BaseImage:   baseImage,
		Entrypoint:  cozyConfig.Entrypoint,
		Description: ImageDescription(cozyConfig),
		IsGPU:       isGPU,
		CudaVersion: cudaVersion,
		Root:        cozyConfig.Root,
	}

	if cozyConfig.Environment != nil {
		data.Environment = cozyConfig.Environment
	} else {
		data.Environment = make(map[string]string)
	}

	// Add deployment ID as environment variable
	if cozyConfig.DeploymentID != "" {
		data.Environment["COZY_DEPLOYMENT_ID"] = cozyConfig.DeploymentID
		data.DeploymentID = cozyConfig.DeploymentID
	}

	// Select template based on GPU configuration
	templateStr := cpuDockerfileTemplate
	if isGPU {
		templateStr = gpuDockerfileTemplate
	}

	tmpl, err := template.New("Dockerfile").Parse(templateStr)
	if err != nil {
		return "", err
	}

	var buf bytes.Buffer
	if err := tmpl.Execute(&buf, data); err != nil {
		return "", err
	}

	return buf.String(), nil
}
